# 阿里云服务器部署指南

## 一、服务器环境准备

### 1.1 连接到阿里云服务器

```bash
ssh root@你的服务器IP
```

### 1.2 安装必要软件

#### 安装 Node.js (推荐使用 nvm)

```bash
# 安装 nvm
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc

# 安装 Node.js 18+
nvm install 18
nvm use 18
node -v
```

#### 安装 pnpm

```bash
npm install -g pnpm
```

#### 安装 MySQL

```bash
# CentOS/Alibaba Cloud Linux
sudo yum install mysql-server -y
sudo systemctl start mysqld
sudo systemctl enable mysqld

# Ubuntu/Debian
sudo apt update
sudo apt install mysql-server -y
sudo systemctl start mysql
sudo systemctl enable mysql

# 设置 MySQL root 密码
sudo mysql_secure_installation
```

#### 安装 PM2 (进程管理器)

```bash
npm install -g pm2
```

#### 安装 Nginx (可选，用于反向代理)

```bash
# CentOS/Alibaba Cloud Linux
sudo yum install nginx -y

# Ubuntu/Debian
sudo apt install nginx -y

sudo systemctl start nginx
sudo systemctl enable nginx
```

## 二、数据库配置

### 2.1 创建数据库

```bash
mysql -u root -p
```

```sql
-- 创建数据库
CREATE DATABASE cost_management CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建专用数据库用户（推荐）
CREATE USER 'cost_user'@'localhost' IDENTIFIED BY '你的强密码';
GRANT ALL PRIVILEGES ON cost_management.* TO 'cost_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

## 三、部署应用

### 3.1 上传代码到服务器

#### 方式一：使用 Git（推荐）

```bash
# 在服务器上
cd /var/www
git clone 你的仓库地址 cost-manage-serve
cd cost-manage-serve
```

#### 方式二：使用 SCP 上传

```bash
# 在本地电脑上
# 先打包项目（排除 node_modules）
tar -czf cost-manage-serve.tar.gz --exclude=node_modules --exclude=dist .

# 上传到服务器
scp cost-manage-serve.tar.gz root@你的服务器IP:/var/www/

# 在服务器上解压
ssh root@你的服务器IP
cd /var/www
tar -xzf cost-manage-serve.tar.gz
mv cost-manage-serve.tar.gz cost-manage-serve
cd cost-manage-serve
```

### 3.2 配置环境变量

```bash
# 创建生产环境配置文件
nano .env.production
```

```env
# 数据库配置
DATABASE_URL="mysql://cost_user:你的数据库密码@localhost:3306/cost_management"

# JWT 配置
JWT_SECRET="你的JWT密钥（建议重新生成一个强密钥）"
JWT_EXPIRES_IN="7d"

# 服务配置
PORT=3000
NODE_ENV=production
```

### 3.3 安装依赖并构建

```bash
# 安装依赖
pnpm install

# 生成 Prisma Client
npx prisma generate

# 运行数据库迁移
npx prisma migrate deploy

# 构建项目
pnpm run build
```

### 3.4 使用 PM2 启动应用

```bash
# 启动应用
pm2 start dist/main.js --name cost-manage-serve

# 设置开机自启
pm2 startup
pm2 save

# 查看应用状态
pm2 status

# 查看日志
pm2 logs cost-manage-serve
```

## 四、配置 Nginx 反向代理（推荐）

### 4.1 创建 Nginx 配置

```bash
sudo nano /etc/nginx/conf.d/cost-manage.conf
```

```nginx
server {
    listen 80;
    server_name 你的域名或IP;

    # 日志配置
    access_log /var/log/nginx/cost-manage-access.log;
    error_log /var/log/nginx/cost-manage-error.log;

    # 反向代理到 NestJS 应用
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # Swagger 文档
    location /api {
        proxy_pass http://localhost:3000/api;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

### 4.2 测试并重启 Nginx

```bash
# 测试配置
sudo nginx -t

# 重启 Nginx
sudo systemctl restart nginx
```

## 五、配置防火墙

### 5.1 阿里云安全组配置

登录阿里云控制台 → ECS 实例 → 安全组 → 配置规则

添加入方向规则：

- HTTP: 端口 80，源地址 0.0.0.0/0
- HTTPS: 端口 443，源地址 0.0.0.0/0
- SSH: 端口 22，源地址 你的IP（安全起见）

### 5.2 服务器防火墙配置

```bash
# CentOS/Alibaba Cloud Linux (firewalld)
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload

# Ubuntu (ufw)
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable
```

## 六、SSL 证书配置（可选但推荐）

### 6.1 使用 Let's Encrypt 免费证书

```bash
# 安装 Certbot
# CentOS
sudo yum install certbot python3-certbot-nginx -y

# Ubuntu
sudo apt install certbot python3-certbot-nginx -y

# 获取证书并自动配置 Nginx
sudo certbot --nginx -d 你的域名

# 设置自动续期
sudo certbot renew --dry-run
```

## 七、常用运维命令

### 7.1 PM2 管理

```bash
# 查看应用状态
pm2 status

# 重启应用
pm2 restart cost-manage-serve

# 停止应用
pm2 stop cost-manage-serve

# 查看日志
pm2 logs cost-manage-serve

# 清空日志
pm2 flush

# 监控
pm2 monit
```

### 7.2 数据库备份

```bash
# 备份数据库
mysqldump -u cost_user -p cost_management > backup_$(date +%Y%m%d).sql

# 恢复数据库
mysql -u cost_user -p cost_management < backup_20250115.sql
```

### 7.3 应用更新流程

```bash
# 1. 拉取最新代码
cd /var/www/cost-manage-serve
git pull

# 2. 安装新依赖
pnpm install

# 3. 运行数据库迁移（如有）
npx prisma migrate deploy

# 4. 重新构建
pnpm run build

# 5. 重启应用
pm2 restart cost-manage-serve

# 6. 查看日志确认启动成功
pm2 logs cost-manage-serve --lines 50
```

## 八、监控和日志

### 8.1 设置日志轮转

```bash
sudo nano /etc/logrotate.d/cost-manage
```

```
/var/log/nginx/cost-manage-*.log {
    daily
    missingok
    rotate 14
    compress
    delaycompress
    notifempty
    create 0640 nginx nginx
    sharedscripts
    postrotate
        [ -f /var/run/nginx.pid ] && kill -USR1 `cat /var/run/nginx.pid`
    endscript
}
```

### 8.2 PM2 监控

```bash
# 安装 PM2 Plus（可选，提供 Web 监控界面）
pm2 plus
```

## 九、性能优化建议

### 9.1 MySQL 优化

```bash
sudo nano /etc/my.cnf
```

```ini
[mysqld]
max_connections = 200
innodb_buffer_pool_size = 1G
innodb_log_file_size = 256M
query_cache_size = 64M
```

### 9.2 Node.js 应用优化

- 使用 PM2 cluster 模式（多进程）

```bash
pm2 start dist/main.js --name cost-manage-serve -i max
```

## 十、故障排查

### 10.1 应用无法启动

```bash
# 查看详细日志
pm2 logs cost-manage-serve --lines 100

# 检查端口占用
netstat -tlnp | grep 3000

# 检查数据库连接
mysql -u cost_user -p -h localhost cost_management
```

### 10.2 Nginx 502 错误

```bash
# 检查应用是否运行
pm2 status

# 检查 Nginx 错误日志
sudo tail -f /var/log/nginx/error.log

# 检查 SELinux（CentOS）
sudo setenforce 0  # 临时关闭测试
```

## 十一、安全建议

1. 定期更新系统和软件包
2. 使用强密码和 SSH 密钥认证
3. 配置防火墙只开放必要端口
4. 定期备份数据库
5. 使用 HTTPS
6. 限制 MySQL 远程访问
7. 定期查看日志，监控异常访问

## 访问应用

部署完成后，通过以下地址访问：

- 应用: http://你的服务器IP 或 http://你的域名
- API 文档: http://你的服务器IP/api 或 http://你的域名/api
