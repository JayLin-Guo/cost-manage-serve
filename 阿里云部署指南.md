# 阿里云 ECS 从0到1部署前后端服务指南

> 记录完整的部署过程，包括遇到的问题及解决方案

## 一、登录阿里云控制台

### 1.1 找到 ECS 实例

1. 登录 [阿里云控制台](https://ecs.console.aliyun.com/)
2. 进入 **云服务器 ECS** → **实例列表**
3. 找到目标实例，记录 **公网 IP 地址**

### 1.2 重置实例密码（如忘记密码）

1. 在实例列表中，点击目标实例的 **更多** → **密码/密钥** → **重置实例密码**
2. 设置新密码（需包含大小写字母、数字、特殊字符）
3. **重要**：重置密码后需要 **重启实例** 才能生效

## 二、SSH 远程连接服务器

### 2.1 使用 MobaXterm 连接

1. 打开 MobaXterm.exe
2. 点击 **Session** → **SSH**
3. 填写连接信息：
   - **Remote host**: 你的公网 IP
   - **Username**: root
   - **Port**: 22
4. 点击 **OK**，输入密码连接

### 2.2 使用命令行连接（可选）

```bash
ssh root@你的公网IP
```

## 三、安装基础环境

### 3.0 安装 Git（如未预装）

```bash
# CentOS / Alibaba Cloud Linux
sudo yum install git -y

# Ubuntu / Debian
sudo apt install git -y

# 验证安装
git --version
```

### 3.1 安装 nvm（Node 版本管理器）

```bash
# 下载并安装 nvm
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash

# 重新加载配置
source ~/.bashrc

# 验证安装
nvm --version
```

### 3.2 使用 nvm 安装 Node.js 18

```bash
# 安装 Node.js 18
nvm install 18

# 设置默认版本
nvm use 18
nvm alias default 18

# 验证安装
node -v
npm -v
```

### 3.3 安装 pnpm

```bash
# 使用 npm 安装 pnpm
npm install -g pnpm

# 验证安装
pnpm -v
```

### 3.4 安装 PM2（进程管理器）

```bash
npm install -g pm2
```

## 四、安装 MySQL（重点）

### 4.1 安装 MySQL

```bash
# CentOS / Alibaba Cloud Linux
sudo yum install mysql-server -y

# Ubuntu / Debian
sudo apt update
sudo apt install mysql-server -y
```

### 4.2 启动 MySQL 服务

```bash
# 启动服务
sudo systemctl start mysqld

# 设置开机自启
sudo systemctl enable mysqld

# 查看服务状态
sudo systemctl status mysqld
```

### 4.3 设置 root 密码

#### 方法一：使用 mysql_secure_installation（推荐）

```bash
sudo mysql_secure_installation
```

按提示操作：

- 设置 root 密码
- 移除匿名用户
- 禁止 root 远程登录
- 删除测试数据库
- 重新加载权限表

#### 方法二：直接登录设置（如果初始无密码）

```bash
# 直接登录
sudo mysql

# 设置 root 密码
ALTER USER 'root'@'localhost' IDENTIFIED BY '你的新密码';
FLUSH PRIVILEGES;
EXIT;
```

### 4.4 登录 MySQL

```bash
mysql -u root -p
# 输入密码后进入 MySQL 命令行
```

### 4.5 创建数据库用户并授权

```sql
-- 创建数据库
CREATE DATABASE cost_management CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建用户
CREATE USER 'cost_user'@'localhost' IDENTIFIED BY '用户密码';

-- 授予权限（只对指定数据库）
GRANT ALL PRIVILEGES ON cost_management.* TO 'cost_user'@'localhost';

-- 刷新权限
FLUSH PRIVILEGES;

-- 验证用户创建成功
SELECT user, host FROM mysql.user;

-- 退出
EXIT;
```

### 4.6 验证新用户登录

```bash
mysql -u cost_user -p
# 输入用户密码
```

```sql
-- 查看可访问的数据库
SHOW DATABASES;

-- 使用数据库
USE cost_management;
```

---

## ⚠️ MySQL 常见问题及解决方案

### 问题一：`--skip-grant-tables` 模式下的权限问题

**症状**：

- 无法创建用户
- 无法授权
- 执行 `FLUSH PRIVILEGES` 后无法登录

**原因**：`--skip-grant-tables` 模式跳过了权限验证，但也导致权限表未正确加载

**解决步骤**：

```bash
# 1. 停止 MySQL 服务
sudo systemctl stop mysqld

# 2. 以跳过权限验证模式启动
sudo mysqld_safe --skip-grant-tables &

# 3. 无密码登录
mysql -u root

# 4. 【关键】先刷新权限表，使权限系统生效
FLUSH PRIVILEGES;

# 5. 现在可以正常设置密码
ALTER USER 'root'@'localhost' IDENTIFIED BY '新密码';

# 6. 再次刷新权限
FLUSH PRIVILEGES;

# 7. 退出
EXIT;

# 8. 停止 mysqld_safe 进程
sudo pkill mysqld

# 9. 正常启动 MySQL
sudo systemctl start mysqld

# 10. 使用新密码登录验证
mysql -u root -p
```

### 问题二：密码策略太严格

**症状**：`ERROR 1819 (HY000): Your password does not satisfy the current policy requirements`

**解决方案**：

```sql
-- 查看当前密码策略
SHOW VARIABLES LIKE 'validate_password%';

-- 临时降低密码策略（开发环境）
SET GLOBAL validate_password.policy = LOW;
SET GLOBAL validate_password.length = 6;

-- 或者直接使用符合策略的强密码
-- 密码需包含：大写字母、小写字母、数字、特殊字符，长度>=8
```

### 问题三：用户已存在

**症状**：`ERROR 1396 (HY000): Operation CREATE USER failed for 'user'@'localhost'`

**解决方案**：

```sql
-- 先删除已存在的用户
DROP USER IF EXISTS 'cost_user'@'localhost';

-- 重新创建
CREATE USER 'cost_user'@'localhost' IDENTIFIED BY '密码';
```

### 问题四：无法远程连接 MySQL

**解决方案**：

```sql
-- 创建允许远程连接的用户
CREATE USER 'cost_user'@'%' IDENTIFIED BY '密码';
GRANT ALL PRIVILEGES ON cost_management.* TO 'cost_user'@'%';
FLUSH PRIVILEGES;
```

```bash
# 修改 MySQL 配置允许远程连接
sudo nano /etc/my.cnf

# 添加或修改
[mysqld]
bind-address = 0.0.0.0

# 重启 MySQL
sudo systemctl restart mysqld
```

**注意**：还需要在阿里云安全组中开放 3306 端口

---

## 五、MySQL 常用命令速查

### 服务管理

```bash
# 启动
sudo systemctl start mysqld

# 停止
sudo systemctl stop mysqld

# 重启
sudo systemctl restart mysqld

# 查看状态
sudo systemctl status mysqld

# 设置开机自启
sudo systemctl enable mysqld

# 取消开机自启
sudo systemctl disable mysqld
```

### 用户和权限管理

```sql
-- 查看所有用户
SELECT user, host FROM mysql.user;

-- 查看用户权限
SHOW GRANTS FOR 'cost_user'@'localhost';

-- 创建用户
CREATE USER '用户名'@'localhost' IDENTIFIED BY '密码';

-- 修改用户密码
ALTER USER '用户名'@'localhost' IDENTIFIED BY '新密码';

-- 授予所有权限
GRANT ALL PRIVILEGES ON 数据库名.* TO '用户名'@'localhost';

-- 授予特定权限
GRANT SELECT, INSERT, UPDATE, DELETE ON 数据库名.* TO '用户名'@'localhost';

-- 撤销权限
REVOKE ALL PRIVILEGES ON 数据库名.* FROM '用户名'@'localhost';

-- 删除用户
DROP USER '用户名'@'localhost';

-- 刷新权限（修改权限后必须执行）
FLUSH PRIVILEGES;
```

### 数据库管理

```sql
-- 查看所有数据库
SHOW DATABASES;

-- 创建数据库
CREATE DATABASE 数据库名 CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 删除数据库
DROP DATABASE 数据库名;

-- 使用数据库
USE 数据库名;

-- 查看当前数据库的表
SHOW TABLES;
```

## 六、部署应用

### 6.1 上传代码到服务器

#### 方式一：使用 Git（推荐）

```bash
# 在服务器上创建目录
mkdir -p /var/www
cd /var/www

# 克隆代码
git clone 你的仓库地址 cost-manage-serve
cd cost-manage-serve
```

#### 方式二：使用 SCP 上传

```bash
# 在本地电脑上打包（排除 node_modules）
tar -czf project.tar.gz --exclude=node_modules --exclude=dist .

# 上传到服务器
scp project.tar.gz root@你的服务器IP:/var/www/

# 在服务器上解压
cd /var/www
mkdir cost-manage-serve
tar -xzf project.tar.gz -C cost-manage-serve
cd cost-manage-serve
```

### 6.2 配置环境变量

```bash
# 创建 .env 文件
nano .env
```

```env
# 数据库配置
DATABASE_URL="mysql://cost_user:你的密码@localhost:3306/cost_management"

# JWT 配置
JWT_SECRET="你的JWT密钥"
JWT_EXPIRES_IN="7d"

# 服务配置
PORT=3000
NODE_ENV=production
```

### 6.3 安装依赖并构建

```bash
# 安装依赖
pnpm install

# 生成 Prisma Client
npx prisma generate

# 运行数据库迁移
npx prisma migrate deploy

# 构建项目
pnpm run build
```

### 6.4 使用 PM2 启动应用

```bash
# 启动应用
pm2 start dist/main.js --name cost-manage-serve

# 设置开机自启
pm2 startup
pm2 save

# 查看状态
pm2 status

# 查看日志
pm2 logs cost-manage-serve
```

## 七、配置 Nginx 反向代理（可选）

### 7.1 安装 Nginx

```bash
# CentOS / Alibaba Cloud Linux
sudo yum install nginx -y

# Ubuntu / Debian
sudo apt install nginx -y

# 启动并设置开机自启
sudo systemctl start nginx
sudo systemctl enable nginx
```

### 7.2 配置反向代理

```bash
sudo nano /etc/nginx/conf.d/cost-manage.conf
```

```nginx
server {
    listen 80;
    server_name 你的域名或IP;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_cache_bypass $http_upgrade;
    }
}
```

```bash
# 测试配置
sudo nginx -t

# 重启 Nginx
sudo systemctl restart nginx
```

## 八、配置阿里云安全组（重要）

> 安全组相当于云服务器的防火墙，必须开放对应端口才能访问服务

### 8.1 进入安全组配置

1. 登录 [阿里云控制台](https://ecs.console.aliyun.com/)
2. 进入 **云服务器 ECS** → **实例列表**
3. 点击目标实例 ID，进入实例详情页
4. 左侧菜单选择 **安全组** 或在实例详情页找到 **安全组** 模块
5. 点击安全组 ID 进入安全组详情
6. 选择 **入方向** 标签页
7. 点击 **手动添加** 或 **快速添加**

### 8.2 添加入方向规则

#### 快速添加（常用端口）

点击 **快速添加**，勾选需要的端口：

- ✅ SSH (22)
- ✅ HTTP (80)
- ✅ HTTPS (443)

#### 手动添加（自定义端口）

点击 **手动添加**，填写以下信息：

| 授权策略 | 优先级 | 协议类型   | 端口范围  | 授权对象  | 描述                  |
| -------- | ------ | ---------- | --------- | --------- | --------------------- |
| 允许     | 1      | 自定义 TCP | 22/22     | 你的IP/32 | SSH远程连接           |
| 允许     | 1      | 自定义 TCP | 80/80     | 0.0.0.0/0 | HTTP访问              |
| 允许     | 1      | 自定义 TCP | 443/443   | 0.0.0.0/0 | HTTPS访问             |
| 允许     | 1      | 自定义 TCP | 3000/3000 | 0.0.0.0/0 | Node.js应用端口       |
| 允许     | 1      | 自定义 TCP | 3306/3306 | 你的IP/32 | MySQL（如需远程连接） |

### 8.3 字段说明

- **授权策略**：允许 / 拒绝
- **优先级**：1-100，数字越小优先级越高
- **协议类型**：TCP / UDP / ICMP / 全部
- **端口范围**：格式为 `起始端口/结束端口`，如 `80/80` 或 `3000/3010`
- **授权对象**：
  - `0.0.0.0/0` - 允许所有 IP 访问（公开服务使用）
  - `你的IP/32` - 只允许指定 IP 访问（安全敏感端口使用）
  - `10.0.0.0/8` - 允许内网 IP 段访问

### 8.4 常用端口配置建议

| 端口 | 服务    | 授权对象建议   | 说明                     |
| ---- | ------- | -------------- | ------------------------ |
| 22   | SSH     | 你的IP/32      | 限制 IP 更安全           |
| 80   | HTTP    | 0.0.0.0/0      | Web 服务公开访问         |
| 443  | HTTPS   | 0.0.0.0/0      | Web 服务公开访问         |
| 3000 | Node.js | 0.0.0.0/0      | 后端 API（如不用 Nginx） |
| 3306 | MySQL   | 内网IP或指定IP | 不建议公开               |
| 6379 | Redis   | 内网IP或指定IP | 不建议公开               |

### 8.5 验证端口是否开放

```bash
# 在本地电脑测试端口连通性
# Windows PowerShell
Test-NetConnection -ComputerName 你的服务器IP -Port 3000

# Linux / Mac
nc -zv 你的服务器IP 3000
# 或
telnet 你的服务器IP 3000
```

### 8.6 常见问题

**问题：安全组已配置但仍无法访问**

检查以下几点：

1. 服务是否已启动：`pm2 status` 或 `systemctl status nginx`
2. 服务是否监听正确端口：`netstat -tlnp | grep 3000`
3. 服务器防火墙是否开放：

   ```bash
   # CentOS 查看防火墙状态
   sudo firewall-cmd --list-all

   # 开放端口
   sudo firewall-cmd --permanent --add-port=3000/tcp
   sudo firewall-cmd --reload
   ```

4. 应用是否绑定到 `0.0.0.0` 而不是 `127.0.0.1`

## 九、常用运维命令

### PM2 管理

```bash
pm2 status              # 查看状态
pm2 restart app-name    # 重启应用
pm2 stop app-name       # 停止应用
pm2 delete app-name     # 删除应用
pm2 logs app-name       # 查看日志
pm2 monit               # 监控面板
```

### 应用更新流程

```bash
cd /var/www/cost-manage-serve
git pull
pnpm install
npx prisma migrate deploy
pnpm run build
pm2 restart cost-manage-serve
```

### 数据库备份

```bash
# 备份
mysqldump -u cost_user -p cost_management > backup_$(date +%Y%m%d).sql

# 恢复
mysql -u cost_user -p cost_management < backup_20250116.sql
```

## 十、故障排查

### 10.1 应用无法启动

```bash
# 查看详细错误日志
pm2 logs cost-manage-serve --lines 100

# 检查端口是否被占用
netstat -tlnp | grep 3000

# 手动运行查看错误（调试用）
node dist/main.js
```

### 10.2 数据库连接失败

```bash
# 检查 MySQL 服务状态
sudo systemctl status mysqld

# 测试数据库连接
mysql -u cost_user -p -h localhost cost_management

# 检查 .env 中的 DATABASE_URL 是否正确
cat .env | grep DATABASE_URL
```

### 10.3 Prisma 迁移失败

```bash
# 查看迁移状态
npx prisma migrate status

# 重置数据库（开发环境，会清空数据！）
npx prisma migrate reset

# 强制部署迁移
npx prisma migrate deploy
```

### 10.4 权限问题

```bash
# 如果遇到权限不足
sudo chown -R $USER:$USER /var/www/cost-manage-serve

# 给脚本执行权限
chmod +x scripts/*.sh
```

---

## 十一、使用 MobaXterm 上传文件

> MobaXterm 自带 SFTP 功能，可以直接拖拽上传文件

### 11.1 拖拽上传

1. SSH 连接成功后，左侧会自动显示 SFTP 文件浏览器
2. 在本地找到要上传的文件
3. 直接拖拽到左侧的目标目录即可

### 11.2 使用 SFTP 命令

```bash
# 在 MobaXterm 中可以直接使用
# 上传文件
put 本地文件路径 /var/www/

# 下载文件
get /var/www/文件名 本地路径
```

### 11.3 上传整个项目（推荐打包后上传）

```bash
# 本地打包（在项目根目录执行）
tar -czf project.tar.gz --exclude=node_modules --exclude=dist --exclude=.git .

# 拖拽 project.tar.gz 到服务器 /var/www/ 目录

# 在服务器上解压
cd /var/www
mkdir -p cost-manage-serve
tar -xzf project.tar.gz -C cost-manage-serve
```

---

## 十二、部署完成

访问地址：

- 应用: `http://你的服务器IP:3000` 或 `http://你的域名`
- API 文档: `http://你的服务器IP:3000/api`

---

## 附录：部署检查清单

- [ ] 阿里云实例运行中，已记录公网 IP
- [ ] SSH 可以正常连接
- [ ] Node.js 18+ 已安装 (`node -v`)
- [ ] pnpm 已安装 (`pnpm -v`)
- [ ] PM2 已安装 (`pm2 -v`)
- [ ] MySQL 已安装并运行 (`systemctl status mysqld`)
- [ ] 数据库和用户已创建
- [ ] 代码已上传到服务器
- [ ] .env 环境变量已配置
- [ ] 依赖已安装 (`pnpm install`)
- [ ] Prisma 迁移已执行 (`npx prisma migrate deploy`)
- [ ] 项目已构建 (`pnpm run build`)
- [ ] PM2 已启动应用 (`pm2 status`)
- [ ] 安全组已开放对应端口
- [ ] 可以通过公网 IP 访问服务
