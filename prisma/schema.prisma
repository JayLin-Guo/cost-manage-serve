// prisma/schema.prisma
// 造价管理系统 - 完整数据库模型设计

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ==================== 部门模块 ====================
/// 部门表：支持树形结构的组织架构
model Department {
  id       String       @id @default(cuid()) /// 部门唯一标识
  name     String       @db.VarChar(50) /// 部门名称
  code     String       @db.VarChar(50) /// 部门编码
  parentId String?      @db.VarChar(50) /// 父部门ID（为空表示顶级部门）
  parent   Department?  @relation("DepartmentHierarchy", fields: [parentId], references: [id]) /// 父部门（自关联：通过 parentId 关联到父部门的 id）
  children Department[] @relation("DepartmentHierarchy") /// 子部门列表（自关联：当前部门作为父部门时的所有子部门）

  isActive  Boolean  @default(true) /// 是否启用
  createdAt DateTime @default(now()) @map("created_at") /// 创建时间
  updatedAt DateTime @updatedAt @map("updated_at") /// 更新时间

  // 关联关系（反向关系）
  users User[] /// 部门下的用户列表（一对多：User 表中 departmentId 指向本部门的所有用户）

  @@map("departments")
}

// ==================== 用户模块 ====================
/// 用户表：系统用户基本信息和权限管理
model User {
  id       String  @id @default(cuid()) /// 用户唯一标识
  username String  @unique @db.VarChar(50) /// 登录用户名（唯一）
  password String  @db.VarChar(255) /// 密码（加密存储）
  name     String  @db.VarChar(50) /// 真实姓名
  email    String? @unique @db.VarChar(100) /// 邮箱（唯一，可选）
  phone    String? @db.VarChar(20) /// 手机号（可选）

  roleCategoryId String?       @map("role_category_id") /// 角色分类ID（可选）
  roleCategory   RoleCategory? @relation(fields: [roleCategoryId], references: [id]) /// 角色分类（多对一：通过 roleCategoryId 关联到 RoleCategory 表的 id）

  avatar    String?  @db.VarChar(500) /// 头像URL
  isActive  Boolean  @default(true) /// 是否启用
  createdAt DateTime @default(now()) @map("created_at") /// 创建时间
  updatedAt DateTime @updatedAt @map("updated_at") /// 更新时间

  departmentId String?     @db.VarChar(50) /// 所属部门ID
  department   Department? @relation(fields: [departmentId], references: [id]) /// 所属部门（多对一：通过 departmentId 关联到 Department 表的 id）

  // 关联关系（反向关系：从其他表指向当前用户的所有记录）
  createdProjects  Project[]         @relation("ProjectCreator") /// 创建的项目列表（一对多：Project 表中 creatorId 指向本用户的所有项目）
  ledTasks         Task[]            @relation("TaskLeader") /// 负责的任务列表（一对多：Task 表中 taskLeaderId 指向本用户的所有任务）
  taskParticipants TaskParticipant[] /// 参与的任务列表（一对多：TaskParticipant 表中 userId 指向本用户的所有参与记录）

  @@map("users")
}

/// 角色分类表：定义用户角色分类
model RoleCategory {
  id          String  @id @default(cuid()) /// 角色分类唯一标识
  name        String  @db.VarChar(20) /// 角色分类名称
  code        String  @db.VarChar(30) /// 角色分类编码
  description String? @db.Text /// 角色分类描述

  isActive  Boolean  @default(true) /// 是否启用
  createdAt DateTime @default(now()) @map("created_at") /// 创建时间
  updatedAt DateTime @updatedAt @map("updated_at") /// 更新时间

  // 关联关系（反向关系）
  users           User[] /// 该角色分类下的用户列表（一对多：User 表中 roleCategoryId 指向本分类的所有用户）
  reviewStepRoles ReviewStepRole[] /// 参与的审核步骤角色

  @@map("role_categories")
}

// ==================== 任务分类模块 ====================
/// 任务分类表：定义不同类型的任务及其审核流程模板
/// 例如："工程造价审核"、"预算编制"、"结算审核"等
model TaskCategory {
  id          String  @id @default(cuid()) /// 分类唯一标识
  name        String  @db.VarChar(50) /// 分类名称
  code        String  @db.VarChar(50) /// 分类编码
  description String? @db.Text /// 分类描述
  sort        Int?    @default(0) /// 排序字段

  reviewConfigId String?       @map("review_config_id") /// 关联的审核配置ID（可选）
  reviewConfig   ReviewConfig? @relation(fields: [reviewConfigId], references: [id]) /// 关联的审核配置（多对一：通过 reviewConfigId 关联到 ReviewConfig 表的 id）

  isActive  Boolean  @default(true) /// 是否启用
  createdAt DateTime @default(now()) @map("created_at") /// 创建时间
  updatedAt DateTime @updatedAt @map("updated_at") /// 更新时间

  // 关联关系（反向关系）
  tasks          Task[] /// 该分类下的所有任务（一对多：Task 表中 taskCategoryId 指向本分类的所有任务）
  stageTemplates TaskCategoryStageTemplate[] /// 该分类定义的审核步骤模板（一对多：TaskCategoryStageTemplate 表中 taskCategoryId 指向本分类的所有模板）

  @@index([reviewConfigId]) /// 审核配置索引
  @@map("task_categories")
}

/// 任务分类的审核步骤模板
/// 说明：每个分类预先定义这类任务要走哪些审核步骤（第1步/第2步/第3步...）
/// 例如：“工程造价审核”分类定义了3个步骤：一审 → 二审 → 终审
model TaskCategoryStageTemplate {
  id String @id @default(cuid()) /// 模板唯一标识

  taskCategoryId String       @db.VarChar(50) /// 所属任务分类ID
  taskCategory   TaskCategory @relation(fields: [taskCategoryId], references: [id]) /// 所属任务分类（多对一：通过 taskCategoryId 关联到 TaskCategory 表的 id）

  stepOrder  Int /// 步骤顺序：1, 2, 3...（决定审核流程的顺序）
  name       String  @db.VarChar(100) /// 步骤名称，比如 "一审"、"二审"、"终审"
  isRequired Boolean @default(true) /// 是否必须步骤（false 表示可跳过）

  @@unique([taskCategoryId, stepOrder]) /// 同一分类下步骤顺序唯一
  @@map("task_category_stage_templates")
}

// ==================== 项目模块 ====================
/// 项目表：管理造价项目的基本信息
model Project {
  id             String  @id @default(cuid()) /// 项目唯一标识
  projectName    String  @db.VarChar(200) /// 项目名称
  projectType    String  @db.VarChar(100) /// 项目类型（如：建筑工程、市政工程等）
  clientUnit     String  @db.VarChar(200) /// 委托单位
  projectSource  String? @db.VarChar(100) /// 项目来源（可选）
  contractAmount String? @db.VarChar(50) /// 合同金额（可选）
  description    String? @db.Text /// 项目描述
  attachments    Json? /// 附件列表（JSON格式）

  status    ProjectStatus @default(ACTIVE) /// 项目状态
  startDate DateTime? /// 开始日期
  endDate   DateTime? /// 结束日期
  creatorId String        @map("creator_id") /// 创建人ID
  creator   User          @relation("ProjectCreator", fields: [creatorId], references: [id]) /// 创建人（多对一：通过 creatorId 关联到 User 表的 id，关系名 ProjectCreator）
  createdAt DateTime      @default(now()) @map("created_at") /// 创建时间
  updatedAt DateTime      @updatedAt @map("updated_at") /// 更新时间

  // 关联关系（反向关系）
  tasks Task[] /// 项目下的任务列表（一对多：Task 表中 projectId 指向本项目的所有任务）

  @@index([creatorId]) /// 创建人索引
  @@index([projectName]) /// 项目名称索引
  @@index([projectType]) /// 项目类型索引
  @@map("projects")
}

/// 项目状态枚举
enum ProjectStatus {
  ACTIVE /// 进行中
  COMPLETED /// 已完成
  SUSPENDED /// 已暂停
  CANCELLED /// 已取消
}

// ==================== 任务模块 ====================
/// 任务表：具体的造价任务，包含任务信息、参与人员和审核流程
model Task {
  id       String @id @default(cuid()) /// 任务唯一标识
  taskName String @db.VarChar(200) /// 任务名称

  projectId String?  @map("project_id") /// 所属项目ID（可选，允许独立任务）
  project   Project? @relation(fields: [projectId], references: [id]) /// 所属项目（多对一：通过 projectId 关联到 Project 表的 id）

  isReviewRequired Boolean @default(false) /// 是否需要审核（false=直接完成，true=走审核流程）

  taskCategoryId String       @map("task_category_id") /// 任务分类ID（一个任务只能选一种分类）
  taskCategory   TaskCategory @relation(fields: [taskCategoryId], references: [id]) /// 任务分类（多对一：通过 taskCategoryId 关联到 TaskCategory 表的 id）

  taskLeaderId String /// 任务负责人ID
  taskLeader   User   @relation("TaskLeader", fields: [taskLeaderId], references: [id]) /// 任务负责人（多对一：通过 taskLeaderId 关联到 User 表的 id，关系名 TaskLeader）

  participants TaskParticipant[] /// 参与人员列表（一对多：TaskParticipant 表中 taskId 指向本任务的所有参与记录）

  description String? @db.Text /// 任务说明
  attachments Json? /// 附件列表（JSON格式）

  createdAt DateTime @default(now()) @map("created_at") /// 创建时间
  updatedAt DateTime @updatedAt @map("updated_at") /// 更新时间

  @@index([projectId]) /// 项目索引
  @@index([taskCategoryId]) /// 任务分类索引
  @@map("tasks")
}

/// 任务参与人员（多对多关系表）
/// 说明：记录哪些用户参与了这个任务
model TaskParticipant {
  id String @id @default(cuid()) /// 记录唯一标识

  taskId String /// 任务ID
  task   Task   @relation(fields: [taskId], references: [id]) /// 任务（多对一：通过 taskId 关联到 Task 表的 id）

  userId String /// 用户ID
  user   User   @relation(fields: [userId], references: [id]) /// 参与用户（多对一：通过 userId 关联到 User 表的 id）

  @@unique([taskId, userId]) /// 同一任务下用户唯一
  @@map("task_participants")
}

// ==================== 审核配置模块 ====================

/// 审核步骤类型枚举
enum ReviewStepType {
  INITIAL_REVIEW /// 初审
  SECONDARY_REVIEW /// 复审
  FINAL_REVIEW /// 终审
  TECHNICAL_REVIEW /// 技术审核
  FINANCIAL_REVIEW /// 财务审核
  QUALITY_REVIEW /// 质量审核
}

/// 审核步骤模板表（步骤池）
/// 说明：这是审核步骤的"池子"，存储所有可用的标准审核步骤定义
/// 创建审核配置时，从这个池子中选择需要的步骤
model ReviewStepTemplate {
  id          String         @id @default(cuid()) /// 步骤模板唯一标识
  name        String         @db.VarChar(50) /// 步骤名称，如"初审"、"复审"、"终审"
  code        String         @unique @db.VarChar(30) /// 步骤编码
  stepType    ReviewStepType /// 步骤类型枚举
  description String?        @db.Text /// 步骤描述

  isActive  Boolean  @default(true) /// 是否启用
  createdAt DateTime @default(now()) @map("created_at") /// 创建时间
  updatedAt DateTime @updatedAt @map("updated_at") /// 更新时间

  // 关联关系
  reviewSteps ReviewStep[] /// 使用此模板的审核步骤实例（一对多）
  stepRoles   ReviewStepRole[] @relation("TemplateRoles") /// 该模板对应的审核角色列表（一对多）

  @@map("review_step_templates")
}

/// 审核配置主表（定义一套完整的审核流程）
/// 说明：这是通用的基础配置表，定义可复用的审核流程，可以被多个任务分类使用
model ReviewConfig {
  id          String  @id @default(cuid()) /// 配置唯一标识
  name        String  @db.VarChar(100) /// 配置名称，如"标准三级审核流程"、"快速两级审核流程"
  code        String  @unique @db.VarChar(50) /// 配置编码
  description String? @db.Text /// 配置描述

  isActive  Boolean  @default(true) /// 是否启用
  createdAt DateTime @default(now()) @map("created_at") /// 创建时间
  updatedAt DateTime @updatedAt @map("updated_at") /// 更新时间

  // 关联关系
  steps          ReviewStep[]   @relation("ReviewConfigSteps") /// 该配置下的所有审核步骤（一对多）
  taskCategories TaskCategory[] /// 使用此配置的任务分类列表（一对多）

  @@map("review_configs")
}

/// 审核步骤表（已关联到具体审核配置的步骤实例）
/// 说明：从步骤池（ReviewStepTemplate）中选择步骤，并关联到具体的审核配置，定义该配置中步骤的顺序
model ReviewStep {
  id         String  @id @default(cuid()) /// 步骤实例唯一标识
  stepOrder  Int /// 步骤顺序：1, 2, 3...（决定审核流程的顺序）
  isRequired Boolean @default(true) /// 是否必须步骤（false 表示可跳过）

  reviewStepTemplateId String             @map("review_step_template_id") /// 引用的步骤模板ID
  reviewStepTemplate   ReviewStepTemplate @relation(fields: [reviewStepTemplateId], references: [id]) /// 步骤模板（多对一）

  reviewConfigId String       @map("review_config_id") /// 所属审核配置ID
  reviewConfig   ReviewConfig @relation("ReviewConfigSteps", fields: [reviewConfigId], references: [id], onDelete: Cascade) /// 所属审核配置（多对一）

  createdAt DateTime @default(now()) @map("created_at") /// 创建时间
  updatedAt DateTime @updatedAt @map("updated_at") /// 更新时间

  @@unique([reviewConfigId, stepOrder]) /// 同一配置下步骤顺序唯一
  @@index([reviewConfigId]) /// 审核配置索引
  @@index([reviewStepTemplateId]) /// 步骤模板索引
  @@map("review_steps")
}

/// 审核步骤角色关联表（多对多关系）
/// 说明：定义某个审核步骤模板可以由哪些角色来审核
/// 例如："初审"步骤模板可以由"造价工程师"或"项目经理"角色审核
model ReviewStepRole {
  id String @id @default(cuid()) /// 关联唯一标识

  reviewStepTemplateId String             @map("review_step_template_id") /// 审核步骤模板ID
  reviewStepTemplate   ReviewStepTemplate @relation("TemplateRoles", fields: [reviewStepTemplateId], references: [id], onDelete: Cascade) /// 审核步骤模板（多对一）

  roleCategoryId String       @map("role_category_id") /// 角色分类ID
  roleCategory   RoleCategory @relation(fields: [roleCategoryId], references: [id]) /// 角色分类（多对一）

  createdAt DateTime @default(now()) @map("created_at") /// 创建时间
  updatedAt DateTime @updatedAt @map("updated_at") /// 更新时间

  @@unique([reviewStepTemplateId, roleCategoryId]) /// 同一步骤模板下角色唯一
  @@index([reviewStepTemplateId]) /// 审核步骤模板索引
  @@index([roleCategoryId]) /// 角色分类索引
  @@map("review_step_roles")
}


// ==================== 审核任务模块 ====================
