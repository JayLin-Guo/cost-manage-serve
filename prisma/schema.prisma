// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ==================== 用户模块 ====================

model User {
  id         String   @id @default(cuid())
  username   String   @unique @db.VarChar(50)
  password   String   @db.VarChar(255)
  name       String   @db.VarChar(50)
  email      String?  @unique @db.VarChar(100)
  phone      String?  @db.VarChar(20)
  role       UserRole @default(STAFF)
  department String?  @db.VarChar(100)
  avatar     String?  @db.VarChar(500)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // 关联关系
  createdProjects Project[] @relation("ProjectCreator")
  reviewerAssignments ReviewerAssignment[]

  @@map("users")
}

enum UserRole {
   ADMIN           // 系统管理员
  COST_ENGINEER   // 造价工程师  
  SUPERVISOR      // 项目主管
  STAFF           // 普通员工
}

// ==================== 审核人员模块 ====================
model ReviewerAssignment {
  id          String              @id @default(cuid())
  userId       String              @map("user_id")
  user        User                @relation(fields: [userId], references: [id])
  reviewerLevel ReviewerLevel     @default(LEVEL_1)
  department   String?             @db.VarChar(100)
  isActive     Boolean             @default(true)
  assignedDate  DateTime           @default(now()) @map("assigned_date")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  

  
  @@unique([userId, reviewerLevel, department])   // 确保每个用户在每个部门只能有一个审核级别
  @@index([reviewerLevel])
  @@index([updatedAt])
  @@index([department])
  @@map("reviewer_assignments")
}

enum ReviewerLevel {
  LEVEL_1 // 一审
  LEVEL_2 // 二审
  LEVEL_3 // 三审
}

// ==================== 项目模块 ====================

model Project {
  id          String   @id @default(cuid())
  projectName String   @db.VarChar(200)
  projectType String   @db.VarChar(100)
  clientUnit  String   @db.VarChar(200)
  projectSource String?   @db.VarChar(100)
  contractAmount String? @db.VarChar(50)
  description String?  @db.Text
  attachments  Json?  

  status      ProjectStatus @default(ACTIVE)
  startDate   DateTime?
  endDate     DateTime?
  creatorId   String   @map("creator_id")
  creator     User     @relation("ProjectCreator", fields: [creatorId], references: [id])
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([creatorId])
  @@index([projectName])
  @@index([projectType])
  @@map("projects")
}

enum ProjectStatus {
  ACTIVE      // 进行中
  COMPLETED   // 已完成
  SUSPENDED   // 已暂停
  CANCELLED   // 已取消
}

